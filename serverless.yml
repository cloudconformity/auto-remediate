service: auto-remediate

provider:
  name: aws
  runtime: nodejs6.10
  stage: v1
  region: ${opt:region, 'us-east-1'}
  timeout: 10 # optional, in seconds, default is 6
  stackTags:
    service: auto-remediate

package:
  individually: true
  exclude:
   - "node_modules/**"

functions:

  AutoRemediateOrchestrator:
    handler: functions/AutoRemediateOrchestrator.handler
    timeout: 10
    memorySize: 128
    events:
      - sns:
          topicName: CloudConformity
          displayName: CloudConformity topic
    tags:
      Name: Auto Remediate Orchestrator
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateOrchestrator.js
    role: AutoRemediateOrchestratorRole

  AutoRemediateCT-001:
    handler: functions/AutoRemediateCT-001.handler
    memorySize: 128
    tags:
      Name: Auto Remediate CT-001
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateCT-001.js
    role: AutoRemediateCT001Role

  AutoRemediateS3-001:
    handler: functions/AutoRemediateS3-001.handler
    memorySize: 128
    tags:
      Name: Auto Remediate S3-001
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateS3-001.js
    role: AutoRemediateS3001Role

  AutoRemediateS3-002:
    handler: functions/AutoRemediateS3-002.handler
    memorySize: 128
    timeout: 10
    tags:
      Name: Auto Remediate S3-002
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateS3-002.js
        - utils/S3_utils.js
        - node_modules/lodash.isequal/**
    role: AutoRemediateS3002Role
    
  AutoRemediateS3-003:
    handler: functions/AutoRemediateS3-003.handler
    memorySize: 128
    timeout: 10
    tags:
      Name: Auto Remediate S3-003
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateS3-003.js
        - utils/S3_utils.js
        - node_modules/lodash.isequal/**
    role: AutoRemediateS3003Role
    
  AutoRemediateS3-004:
    handler: functions/AutoRemediateS3-004.handler
    memorySize: 128
    timeout: 10
    tags:
      Name: Auto Remediate S3-004
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateS3-004.js
        - utils/S3_utils.js
        - node_modules/lodash.isequal/**
    role: AutoRemediateS3004Role
    
  AutoRemediateS3-005:
    handler: functions/AutoRemediateS3-005.handler
    memorySize: 128
    timeout: 10
    tags:
      Name: Auto Remediate S3-005
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateS3-005.js
        - utils/S3_utils.js
        - node_modules/lodash.isequal/**
    role: AutoRemediateS3005Role
    
  AutoRemediateS3-006:
    handler: functions/AutoRemediateS3-006.handler
    memorySize: 128
    timeout: 10
    tags:
      Name: Auto Remediate S3-006
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateS3-006.js
        - utils/S3_utils.js
        - node_modules/lodash.isequal/**
    role: AutoRemediateS3006Role
    
  AutoRemediateS3-007:
    handler: functions/AutoRemediateS3-007.handler
    memorySize: 128
    timeout: 10
    tags:
      Name: Auto Remediate S3-007
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateS3-007.js
        - utils/S3_utils.js
        - node_modules/lodash.isequal/**
    role: AutoRemediateS3007Role
    
  AutoRemediateS3-008:
    handler: functions/AutoRemediateS3-008.handler
    memorySize: 128
    timeout: 10
    tags:
      Name: Auto Remediate S3-008
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateS3-008.js
        - utils/S3_utils.js
        - node_modules/lodash.isequal/**
    role: AutoRemediateS3008Role
    
  AutoRemediateS3-009:
    handler: functions/AutoRemediateS3-009.handler
    memorySize: 128
    timeout: 10
    tags:
      Name: Auto Remediate S3-009
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateS3-009.js
        - utils/S3_utils.js
        - node_modules/lodash.isequal/**
    role: AutoRemediateS3009Role
    
  AutoRemediateS3-010:
    handler: functions/AutoRemediateS3-010.handler
    memorySize: 128
    timeout: 10
    tags:
      Name: Auto Remediate S3-010
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateS3-010.js
        - utils/S3_utils.js
        - node_modules/lodash.isequal/**
    role: AutoRemediateS3010Role

  AutoRemediateS3-012:
    handler: functions/AutoRemediateS3-012.handler
    memorySize: 128
    tags:
      Name: Auto Remediate S3-012
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateS3-012.js
    role: AutoRemediateS3012Role

  AutoRemediateRDS-008:
    handler: functions/AutoRemediateRDS-008.handler
    memorySize: 128
    tags:
      Name: Auto Remediate RDS-008
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateRDS-008.js
    role: AutoRemediateRDS008Role

  AutoRemediateConfig-001:
    handler: functions/AutoRemediateConfig-001.handler
    timeout: 120
    memorySize: 128
    tags:
      Name: Auto Remediate Config-001
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateConfig-001.js
    role: AutoRemediateConfig001Role

  AutoRemediateCFM-005:
    handler: functions/AutoRemediateCFM-005.handler
    timeout: 120
    memorySize: 128
    tags:
      Name: Auto Remediate CFM-005
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateCFM-005.js
    role: AutoRemediateCFM005Role

  AutoRemediateRS-001:
    handler: functions/AutoRemediateRS-001.handler
    timeout: 120
    memorySize: 128
    tags:
      Name: Auto Remediate RS-001
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateRS-001.js
    role: AutoRemediateRS001Role

  AutoRemediateEC2-002:
    handler: functions/AutoRemediateEC2-002.handler
    timeout: 120
    memorySize: 128
    tags:
      Name: Auto Remediate EC2-002
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateEC2-002.js
    role: AutoRemediateEC2002Role
    
  AutoRemediateEC2-003:
    handler: functions/AutoRemediateEC2-003.handler
    timeout: 120
    memorySize: 128
    tags:
      Name: Auto Remediate EC2-003
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateEC2-003.js
    role: AutoRemediateEC2003Role

  AutoRemediateEC2-005:
    handler: functions/AutoRemediateEC2-005.handler
    timeout: 120
    memorySize: 128
    tags:
      Name: Auto Remediate EC2-005
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateEC2-005.js
    role: AutoRemediateEC2005Role
    
  AutoRemediateEC2-004:
    handler: functions/AutoRemediateEC2-004.handler
    timeout: 120
    memorySize: 128
    tags:
      Name: Auto Remediate EC2-004
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateEC2-004.js
    role: AutoRemediateEC2004Role
    
  AutoRemediateEC2-006:
    handler: functions/AutoRemediateEC2-006.handler
    timeout: 120
    memorySize: 128
    tags:
      Name: Auto Remediate EC2-006
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateEC2-006.js
    role: AutoRemediateEC2006Role
    
  AutoRemediateEC2-008:
    handler: functions/AutoRemediateEC2-008.handler
    timeout: 120
    memorySize: 128
    tags:
      Name: Auto Remediate EC2-008
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateEC2-008.js
    role: AutoRemediateEC2008Role
    
  AutoRemediateEC2-043:
    handler: functions/AutoRemediateEC2-043.handler
    timeout: 120
    memorySize: 128
    tags:
      Name: Auto Remediate EC2-043
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateEC2-043.js
    role: AutoRemediateEC2043Role
    
  AutoRemediateEC2-045:
    handler: functions/AutoRemediateEC2-045.handler
    timeout: 120
    memorySize: 128
    tags:
      Name: Auto Remediate EC2-045
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateEC2-045.js
    role: AutoRemediateEC2045Role
    
  AutoRemediateEC2-038:
    handler: functions/AutoRemediateEC2-038.handler
    timeout: 120
    memorySize: 128
    tags:
      Name: Auto Remediate EC2-038
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateEC2-038.js
    role: AutoRemediateEC2038Role
    
  AutoRemediateEC2-040:
    handler: functions/AutoRemediateEC2-040.handler
    timeout: 120
    memorySize: 128
    tags:
      Name: Auto Remediate EC2-040
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateEC2-040.js
    role: AutoRemediateEC2040Role
    
  AutoRemediateEC2-039:
    handler: functions/AutoRemediateEC2-039.handler
    timeout: 120
    memorySize: 128
    tags:
      Name: Auto Remediate EC2-039
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateEC2-039.js
    role: AutoRemediateEC2039Role
    
  TrustedAdvisor-003:
    handler: functions/AutoRemediateTrustedAdvisor-003.handler
    timeout: 120
    memorySize: 128
    tags:
      Name: Auto Remediate TrustedAdvisor-003
      Owner: CloudConformity
      Role: Auto Remediate
      Environment: Ops
    package:
      include:
        - functions/AutoRemediateTrustedAdvisor-003.js
    role: AutoRemediateTrustedAdvisor003Role

resources:

  Resources:

    AutoRemediateEC2002Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateEC2-002Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateEC2-002Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - ec2:RevokeSecurityGroupIngress
                  Resource: "*"
                  
    AutoRemediateEC2003Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateEC2-003Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateEC2-003Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - ec2:RevokeSecurityGroupIngress
                  Resource: "*"

    AutoRemediateEC2005Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateEC2-005Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateEC2-005Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - ec2:RevokeSecurityGroupIngress
                  Resource: "*"
                  
    AutoRemediateEC2043Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateEC2-043Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateEC2-043Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - ec2:RevokeSecurityGroupIngress
                  Resource: "*"  
                  
    AutoRemediateEC2042Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateEC2-042Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateEC2-042Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - ec2:RevokeSecurityGroupIngress
                  Resource: "*"  

    AutoRemediateRS001Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateRS-001Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateRS-001Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - redshift:ModifyCluster
                  Resource: "*"

    AutoRemediateCFM005Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateCFM-005Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateCFM-005Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - cloudformation:UpdateTerminationProtection
                  Resource: "*"

    AutoRemediateConfig001Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateConfig-001Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateConfig-001Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - config:PutConfigurationRecorder
                    - config:PutDeliveryChannel
                    - config:StartConfigurationRecorder
                  Resource: "*"
                - Effect: Allow
                  Action:
                    - iam:AttachRolePolicy
                    - iam:CreateRole
                    - iam:GetRole
                    - iam:PassRole
                    - iam:PutRolePolicy
                  Resource: "*"
                - Effect: Allow
                  Action:
                    - sts:GetCallerIdentity
                  Resource: "*"

    AutoRemediateRDS008Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateRDS-008Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateRDS-008Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - rds:ModifyDBInstance
                  Resource: "*"

    AutoRemediateCT001Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateCT-001Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateCT-001Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - cloudtrail:UpdateTrail
                  Resource: "*"

    AutoRemediateS3001Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateS3-001Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateS3-001Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - s3:GetBucketAcl
                    - s3:PutBucketAcl
                  Resource: "*"

    AutoRemediateS3002Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateS3-002Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateS3-002Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - s3:GetBucketAcl
                    - s3:PutBucketAcl
                  Resource: "*"
                  
    AutoRemediateS3003Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateS3-003Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateS3-003Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - s3:GetBucketAcl
                    - s3:PutBucketAcl
                  Resource: "*"



    AutoRemediateS3009Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateS3-009Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateS3-009Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - s3:GetBucketAcl
                    - s3:PutBucketAcl
                  Resource: "*"

    AutoRemediateS3012Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateS3-012Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateS3-012Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - s3:PutBucketVersioning
                  Resource: "*"

    AutoRemediateOrchestratorRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateOrchestratorRole
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateOrchestratorPolicy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - lambda:InvokeFunction
                  Resource: "*"
                  
    AutoRemediateS3004Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateS3-004Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateS3-004Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - s3:GetBucketAcl
                    - s3:PutBucketAcl
                  Resource: "*"
                  
    AutoRemediateS3005Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateS3-005Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateS3-005Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - s3:GetBucketAcl
                    - s3:PutBucketAcl
                  Resource: "*"

    AutoRemediateS3006Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateS3-006Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateS3-006Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - s3:GetBucketAcl
                    - s3:PutBucketAcl
                  Resource: "*"

    AutoRemediateS3007Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateS3-007Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateS3-007Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - s3:GetBucketAcl
                    - s3:PutBucketAcl
                  Resource: "*"

    AutoRemediateS3008Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateS3-008Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateS3-008Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - s3:GetBucketAcl
                    - s3:PutBucketAcl
                  Resource: "*"
                  
    AutoRemediateS3010Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateS3-010Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateS3-010Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - s3:GetBucketAcl
                    - s3:PutBucketAcl
                  Resource: "*"
    
    AutoRemediateEC2008Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateEC2-008Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateEC2-008Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - ec2:RevokeSecurityGroupIngress
                  Resource: "*"
                  
    AutoRemediateEC2045Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateEC2-045Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateEC2-045Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - ec2:RevokeSecurityGroupIngress
                  Resource: "*"
                  
    AutoRemediateEC2006Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateEC2-006Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateEC2-006Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - ec2:RevokeSecurityGroupIngress
                  Resource: "*"
                  
    AutoRemediateEC2038Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateEC2-038Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateEC2-038Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - ec2:RevokeSecurityGroupIngress
                  Resource: "*"

    AutoRemediateEC2040Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateEC2-040Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateEC2-040Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - ec2:RevokeSecurityGroupIngress
                  Resource: "*"
                  
    AutoRemediateEC2004Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateEC2-004Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateEC2-004Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - ec2:RevokeSecurityGroupIngress
                  Resource: "*"

    AutoRemediateEC2039Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateEC2-039Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateEC2-039Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - ec2:RevokeSecurityGroupIngress
                  Resource: "*"

    AutoRemediateTrustedAdvisor003Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: AutoRemediateTrustedAdvisor-003Role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: AutoRemediateTrustedAdvisor-003Policy
            PolicyDocument:
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - iam:UpdateAccessKey
                  Resource: "*"

